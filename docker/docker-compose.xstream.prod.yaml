# A bash-able template that will fill with variables if correct environment variables are loaded
# source context.{dev | prod}
# eval echo "" > output.yaml

# XStream dev worker configuration
# For notes on setup see docs/development/architecture.md#XStream-Architecture-Setup

version: \"3.7\" #XStream can only support up to 3.7. Using docker 18.06.1-ce

#######################################
##### DEFAULT IMAGE CONFIGURATION #####
#######################################

# Default images and setup for worker containers
x-default-worker: &default-worker
  image: ${FULL_IMAGE_NAME}
  env_file: worker.env
  environment:
    - TERACHEM_PBS_PORT=11111
    - C_FORCE_ROOT=true # to run celery as root with pickle serializer
  volumes:
    - scratch-vol:/scratch

# Default images and setup for real time worker containers
x-realtime-worker: &realtime-worker
  <<: *default-worker
  environment:
    - TERACHEM_PBS_PORT=11111
    - C_FORCE_ROOT=true # to run celery as root with pickle serializer
  command: celery -A terachem_cloud.workers.tasks worker -Q celery,p100 --without-heartbeat --without-mingle --without-gossip --loglevel=INFO

# Default images and setup for terachem containers
x-default-terachem: &default-terachem
  image: mtzgroup/terachem:1.9-2022.03-dev-cuda10.2-sm_37-sm_52-sm_60
  secrets:
    - source: terachem_license
      target: /terachem/license.key
  volumes:
    - scratch-vol:/scratch

# Default images and setup for TeraChem Frontend container
x-default-terachem-frontend: &default-terachem-frontend
  image: mtzgroup/terachem-frontend:0.2.0-noproxy
  environment:
    - AUTOINDEX_FORMAT=json
    - WORKER_PROCESSES=3
  volumes:
    - scratch-vol:/usr/share/nginx/html

#######################################
#### PER NODE DEPLOY CONFIGURATION ####
#######################################

# NOTE: No xs7-0001 workers accoriding to Stephane to maintain cluster stability.
# Does this really matter? Not clear.

# Deploy to xs7-0002 node
x-xs7-0002-deploy: &xs7-0002
  placement:
    constraints:
      - "node.hostname==xs7-0002"

# Deploy to xs7-0003 node
x-xs7-0003-deploy: &xs7-0003
  placement:
    constraints:
      - "node.hostname==xs7-0003"

# Deploy to xs7-0004 node
x-xs7-0004-deploy: &xs7-0004
  placement:
    constraints:
      - "node.hostname==xs7-0004"

# Deploy to xs7-0005 node
x-xs7-0005-deploy: &xs7-0005
  placement:
    constraints:
      - "node.hostname==xs7-0005"

# Deploy to xs7-0100 node
x-xs7-0100-deploy: &xs7-0100
  placement:
    constraints:
      - "node.hostname==xs7-0100"

#######################################
#### SERVICE-SPECIFIC CONFIGURATION ###
#######################################

# Celery workers on xs7-0002
x-xs7-0002-worker: &xs7-0002-worker
  <<: *default-worker
  deploy:
    <<: *xs7-0002

# TeraChem servers on xs7-0002
x-xs7-0002-terachem: &xs7-0002-terachem
  <<: *default-terachem
  deploy:
    <<: *xs7-0002

# Celery workers on xs7-0003
x-xs7-0003-worker: &xs7-0003-worker
  <<: *default-worker
  deploy:
    <<: *xs7-0003

# TeraChem servers on xs7-0003
x-xs7-0003-terachem: &xs7-0003-terachem
  <<: *default-terachem
  deploy:
    <<: *xs7-0003

# Celery workers on xs7-0004
x-xs7-0004-worker: &xs7-0004-worker
  <<: *default-worker
  deploy:
    <<: *xs7-0004

# TeraChem servers on xs7-0004
x-xs7-0004-terachem: &xs7-0004-terachem
  <<: *default-terachem
  deploy:
    <<: *xs7-0004

# Celery workers on xs7-0005
x-xs7-0005-worker: &xs7-0005-worker
  <<: *default-worker
  deploy:
    <<: *xs7-0005

# TeraChem servers on xs7-0005
x-xs7-0005-terachem: &xs7-0005-terachem
  <<: *default-terachem
  deploy:
    <<: *xs7-0005

# Celery workers on xs7-0100
x-xs7-0100-worker: &xs7-0100-worker
  <<: *realtime-worker
  deploy:
    <<: *xs7-0100

# TeraChem servers on xs7-0100
x-xs7-0100-terachem: &xs7-0100-terachem
  <<: *default-terachem
  deploy:
    <<: *xs7-0100

services:
  # NOTE: For some reason placing TERACHEM_FE_HOST in the SERVICE-SPECIFIC
  # CONFIGURATION would result in docker not adding the environment variable
  # to containers, so I have to add it to all containers here :(

  # xs7-0002 Pod 1: GPU 1; NOTE: GPU 0 used by dev
  xs7-0002-worker-1:
    <<: *xs7-0002-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0002-terachem-1
      - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  xs7-0002-terachem-1:
    <<: *xs7-0002-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=1
  xs7-0002-terachem-frontend:
    <<: *default-terachem-frontend
    deploy:
      <<: *xs7-0002

  # xs7-0002 Pod 2: GPU 2
  xs7-0002-worker-2:
    <<: *xs7-0002-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0002-terachem-2
      - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  xs7-0002-terachem-2:
    <<: *xs7-0002-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=2

  # xs7-0002 Pod 3: GPU 3
  xs7-0002-worker-3:
    <<: *xs7-0002-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0002-terachem-3
      - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  xs7-0002-terachem-3:
    <<: *xs7-0002-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=3

  # xs7-0002 Pod 4: GPU 4
  xs7-0002-worker-4:
    <<: *xs7-0002-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0002-terachem-4
      - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  xs7-0002-terachem-4:
    <<: *xs7-0002-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=4

  # xs7-0002 Pod 5: GPU 5
  xs7-0002-worker-5:
    <<: *xs7-0002-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0002-terachem-5
      - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  xs7-0002-terachem-5:
    <<: *xs7-0002-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=5

  # xs7-0002 Pod 6: GPU 6
  xs7-0002-worker-6:
    <<: *xs7-0002-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0002-terachem-6
      - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  xs7-0002-terachem-6:
    <<: *xs7-0002-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=6

  # xs7-0002 Pod 7: GPU 7
  xs7-0002-worker-7:
    <<: *xs7-0002-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0002-terachem-7
      - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  xs7-0002-terachem-7:
    <<: *xs7-0002-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=7

  # xs7-0002 Pod 8: GPU 8
  xs7-0002-worker-8:
    <<: *xs7-0002-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0002-terachem-8
      - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  xs7-0002-terachem-8:
    <<: *xs7-0002-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=8

  # # xs7-0002 Pod 9: GPU 9
  # xs7-0002-worker-9:
  #   <<: *xs7-0002-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0002-terachem-9
  #     - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  # xs7-0002-terachem-9:
  #   <<: *xs7-0002-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=9

  # # xs7-0002 Pod 10: GPU 10
  # xs7-0002-worker-10:
  #   <<: *xs7-0002-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0002-terachem-10
  #     - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  # xs7-0002-terachem-10:
  #   <<: *xs7-0002-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=10

  # # xs7-0002 Pod 11: GPU 11
  # xs7-0002-worker-11:
  #   <<: *xs7-0002-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0002-terachem-11
  #     - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  # xs7-0002-terachem-11:
  #   <<: *xs7-0002-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=11

  # # xs7-0002 Pod 12: GPU 12
  # xs7-0002-worker-12:
  #   <<: *xs7-0002-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0002-terachem-12
  #     - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  # xs7-0002-terachem-12:
  #   <<: *xs7-0002-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=12

  # # xs7-0002 Pod 13: GPU 13
  # xs7-0002-worker-13:
  #   <<: *xs7-0002-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0002-terachem-13
  #     - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  # xs7-0002-terachem-13:
  #   <<: *xs7-0002-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=13

  # # xs7-0002 Pod 14: GPU 14
  # xs7-0002-worker-14:
  #   <<: *xs7-0002-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0002-terachem-14
  #     - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  # xs7-0002-terachem-14:
  #   <<: *xs7-0002-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=14

  # # xs7-0002 Pod 15: GPU 15
  # xs7-0002-worker-15:
  #   <<: *xs7-0002-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0002-terachem-15
  #     - TERACHEM_FE_HOST=xs7-0002-terachem-frontend
  # xs7-0002-terachem-15:
  #   <<: *xs7-0002-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=15

  # xs7-0003 Pod 1: GPU 1; GPU 0 used by dev
  xs7-0003-worker-1:
    <<: *xs7-0003-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0003-terachem-1
      - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  xs7-0003-terachem-1:
    <<: *xs7-0003-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=1
  xs7-0003-terachem-frontend:
    <<: *default-terachem-frontend
    deploy:
      <<: *xs7-0003

  # xs7-0003 Pod 2: GPU 2
  xs7-0003-worker-2:
    <<: *xs7-0003-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0003-terachem-2
      - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  xs7-0003-terachem-2:
    <<: *xs7-0003-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=2

  # xs7-0003 Pod 3: GPU 3
  xs7-0003-worker-3:
    <<: *xs7-0003-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0003-terachem-3
      - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  xs7-0003-terachem-3:
    <<: *xs7-0003-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=3

  # xs7-0003 Pod 4: GPU 4
  xs7-0003-worker-4:
    <<: *xs7-0003-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0003-terachem-4
      - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  xs7-0003-terachem-4:
    <<: *xs7-0003-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=4

  # xs7-0003 Pod 5: GPU 5
  xs7-0003-worker-5:
    <<: *xs7-0003-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0003-terachem-5
      - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  xs7-0003-terachem-5:
    <<: *xs7-0003-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=5

  # xs7-0003 Pod 6: GPU 6
  xs7-0003-worker-6:
    <<: *xs7-0003-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0003-terachem-6
      - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  xs7-0003-terachem-6:
    <<: *xs7-0003-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=6

  # xs7-0003 Pod 7: GPU 7
  xs7-0003-worker-7:
    <<: *xs7-0003-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0003-terachem-7
      - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  xs7-0003-terachem-7:
    <<: *xs7-0003-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=7

  # xs7-0003 Pod 8: GPU 8
  xs7-0003-worker-8:
    <<: *xs7-0003-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0003-terachem-8
      - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  xs7-0003-terachem-8:
    <<: *xs7-0003-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=8

  # # xs7-0003 Pod 9: GPU 9
  # xs7-0003-worker-9:
  #   <<: *xs7-0003-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0003-terachem-9
  #     - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  # xs7-0003-terachem-9:
  #   <<: *xs7-0003-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=9

  # # xs7-0003 Pod 10: GPU 10
  # xs7-0003-worker-10:
  #   <<: *xs7-0003-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0003-terachem-10
  #     - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  # xs7-0003-terachem-10:
  #   <<: *xs7-0003-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=10

  # # xs7-0003 Pod 11: GPU 11
  # xs7-0003-worker-11:
  #   <<: *xs7-0003-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0003-terachem-11
  #     - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  # xs7-0003-terachem-11:
  #   <<: *xs7-0003-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=11

  # # xs7-0003 Pod 12: GPU 12
  # xs7-0003-worker-12:
  #   <<: *xs7-0003-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0003-terachem-12
  #     - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  # xs7-0003-terachem-12:
  #   <<: *xs7-0003-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=12

  # # xs7-0003 Pod 13: GPU 13
  # xs7-0003-worker-13:
  #   <<: *xs7-0003-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0003-terachem-13
  #     - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  # xs7-0003-terachem-13:
  #   <<: *xs7-0003-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=13

  # # xs7-0003 Pod 14: GPU 14
  # xs7-0003-worker-14:
  #   <<: *xs7-0003-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0003-terachem-14
  #     - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  # xs7-0003-terachem-14:
  #   <<: *xs7-0003-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=14

  # # xs7-0003 Pod 15: GPU 15
  # xs7-0003-worker-15:
  #   <<: *xs7-0003-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0003-terachem-15
  #     - TERACHEM_FE_HOST=xs7-0003-terachem-frontend
  # xs7-0003-terachem-15:
  #   <<: *xs7-0003-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=15

  # xs7-0004 Pod 0: GPU 0
  xs7-0004-worker-0:
    <<: *xs7-0004-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0004-terachem-0
      - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  xs7-0004-terachem-0:
    <<: *xs7-0004-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=0
  xs7-0004-terachem-frontend:
    <<: *default-terachem-frontend
    deploy:
      <<: *xs7-0004

  # xs7-0004 Pod 1: GPU 1;
  xs7-0004-worker-1:
    <<: *xs7-0004-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0004-terachem-1
      - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  xs7-0004-terachem-1:
    <<: *xs7-0004-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=1

  # xs7-0004 Pod 2: GPU 2
  xs7-0004-worker-2:
    <<: *xs7-0004-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0004-terachem-2
      - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  xs7-0004-terachem-2:
    <<: *xs7-0004-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=2

  # xs7-0004 Pod 3: GPU 3
  xs7-0004-worker-3:
    <<: *xs7-0004-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0004-terachem-3
      - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  xs7-0004-terachem-3:
    <<: *xs7-0004-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=3

  # xs7-0004 Pod 4: GPU 4
  xs7-0004-worker-4:
    <<: *xs7-0004-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0004-terachem-4
      - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  xs7-0004-terachem-4:
    <<: *xs7-0004-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=4

  # xs7-0004 Pod 5: GPU 5
  xs7-0004-worker-5:
    <<: *xs7-0004-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0004-terachem-5
      - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  xs7-0004-terachem-5:
    <<: *xs7-0004-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=5

  # xs7-0004 Pod 6: GPU 6
  xs7-0004-worker-6:
    <<: *xs7-0004-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0004-terachem-6
      - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  xs7-0004-terachem-6:
    <<: *xs7-0004-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=6

  # xs7-0004 Pod 7: GPU 7
  xs7-0004-worker-7:
    <<: *xs7-0004-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0004-terachem-7
      - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  xs7-0004-terachem-7:
    <<: *xs7-0004-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=7

  # xs7-0004 Pod 8: GPU 8
  xs7-0004-worker-8:
    <<: *xs7-0004-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0004-terachem-8
      - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  xs7-0004-terachem-8:
    <<: *xs7-0004-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=8

  # # xs7-0004 Pod 9: GPU 9
  # xs7-0004-worker-9:
  #   <<: *xs7-0004-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0004-terachem-9
  #     - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  # xs7-0004-terachem-9:
  #   <<: *xs7-0004-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=9

  # # xs7-0004 Pod 10: GPU 10
  # xs7-0004-worker-10:
  #   <<: *xs7-0004-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0004-terachem-10
  #     - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  # xs7-0004-terachem-10:
  #   <<: *xs7-0004-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=10

  # # xs7-0004 Pod 11: GPU 11
  # xs7-0004-worker-11:
  #   <<: *xs7-0004-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0004-terachem-11
  #     - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  # xs7-0004-terachem-11:
  #   <<: *xs7-0004-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=11

  # # xs7-0004 Pod 12: GPU 12
  # xs7-0004-worker-12:
  #   <<: *xs7-0004-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0004-terachem-12
  #     - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  # xs7-0004-terachem-12:
  #   <<: *xs7-0004-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=12

  # # xs7-0004 Pod 13: GPU 13
  # xs7-0004-worker-13:
  #   <<: *xs7-0004-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0004-terachem-13
  #     - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  # xs7-0004-terachem-13:
  #   <<: *xs7-0004-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=13

  # # xs7-0004 Pod 14: GPU 14
  # xs7-0004-worker-14:
  #   <<: *xs7-0004-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0004-terachem-14
  #     - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  # xs7-0004-terachem-14:
  #   <<: *xs7-0004-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=14

  # # xs7-0004 Pod 15: GPU 15
  # xs7-0004-worker-15:
  #   <<: *xs7-0004-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0004-terachem-15
  #     - TERACHEM_FE_HOST=xs7-0004-terachem-frontend
  # xs7-0004-terachem-15:
  #   <<: *xs7-0004-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=15

  # xs7-0005 Pod 0: GPU 0
  xs7-0005-worker-0:
    <<: *xs7-0005-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0005-terachem-0
      - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  xs7-0005-terachem-0:
    <<: *xs7-0005-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=0
  xs7-0005-terachem-frontend:
    <<: *default-terachem-frontend
    deploy:
      <<: *xs7-0005

  # xs7-0005 Pod 1: GPU 1;
  xs7-0005-worker-1:
    <<: *xs7-0005-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0005-terachem-1
      - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  xs7-0005-terachem-1:
    <<: *xs7-0005-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=1

  # xs7-0005 Pod 2: GPU 2
  xs7-0005-worker-2:
    <<: *xs7-0005-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0005-terachem-2
      - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  xs7-0005-terachem-2:
    <<: *xs7-0005-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=2

  # xs7-0005 Pod 3: GPU 3
  xs7-0005-worker-3:
    <<: *xs7-0005-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0005-terachem-3
      - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  xs7-0005-terachem-3:
    <<: *xs7-0005-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=3

  # xs7-0005 Pod 4: GPU 4
  xs7-0005-worker-4:
    <<: *xs7-0005-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0005-terachem-4
      - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  xs7-0005-terachem-4:
    <<: *xs7-0005-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=4

  # xs7-0005 Pod 5: GPU 5
  xs7-0005-worker-5:
    <<: *xs7-0005-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0005-terachem-5
      - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  xs7-0005-terachem-5:
    <<: *xs7-0005-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=5

  # xs7-0005 Pod 6: GPU 6
  xs7-0005-worker-6:
    <<: *xs7-0005-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0005-terachem-6
      - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  xs7-0005-terachem-6:
    <<: *xs7-0005-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=6

  # xs7-0005 Pod 7: GPU 7
  xs7-0005-worker-7:
    <<: *xs7-0005-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0005-terachem-7
      - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  xs7-0005-terachem-7:
    <<: *xs7-0005-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=7

  # xs7-0005 Pod 8: GPU 8
  xs7-0005-worker-8:
    <<: *xs7-0005-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0005-terachem-8
      - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  xs7-0005-terachem-8:
    <<: *xs7-0005-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=8

  # # xs7-0005 Pod 9: GPU 9
  # xs7-0005-worker-9:
  #   <<: *xs7-0005-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0005-terachem-9
  #     - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  # xs7-0005-terachem-9:
  #   <<: *xs7-0005-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=9

  # # xs7-0005 Pod 10: GPU 10
  # xs7-0005-worker-10:
  #   <<: *xs7-0005-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0005-terachem-10
  #     - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  # xs7-0005-terachem-10:
  #   <<: *xs7-0005-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=10

  # # xs7-0005 Pod 11: GPU 11
  # xs7-0005-worker-11:
  #   <<: *xs7-0005-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0005-terachem-11
  #     - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  # xs7-0005-terachem-11:
  #   <<: *xs7-0005-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=11

  # # xs7-0005 Pod 12: GPU 12
  # xs7-0005-worker-12:
  #   <<: *xs7-0005-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0005-terachem-12
  #     - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  # xs7-0005-terachem-12:
  #   <<: *xs7-0005-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=12

  # # xs7-0005 Pod 13: GPU 13
  # xs7-0005-worker-13:
  #   <<: *xs7-0005-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0005-terachem-13
  #     - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  # xs7-0005-terachem-13:
  #   <<: *xs7-0005-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=13

  # # xs7-0005 Pod 14: GPU 14
  # xs7-0005-worker-14:
  #   <<: *xs7-0005-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0005-terachem-14
  #     - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  # xs7-0005-terachem-14:
  #   <<: *xs7-0005-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=14

  # # xs7-0005 Pod 15: GPU 15
  # xs7-0005-worker-15:
  #   <<: *xs7-0005-worker
  #   environment:
  #     - TERACHEM_PBS_HOST=xs7-0005-terachem-15
  #     - TERACHEM_FE_HOST=xs7-0005-terachem-frontend
  # xs7-0005-terachem-15:
  #   <<: *xs7-0005-terachem
  #   environment:
  #     - NVIDIA_VISIBLE_DEVICES=15

  # Pod 1: xs7-0100, GPU 1 # Note GPUs 0 used by dev
  xs7-0100-worker-1:
    <<: *xs7-0100-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0100-terachem-1
      - TERACHEM_FE_HOST=xs7-0100-terachem-frontend
  xs7-0100-terachem-1:
    <<: *xs7-0100-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=1
  xs7-0100-terachem-frontend:
    <<: *default-terachem-frontend
    deploy:
      <<: *xs7-0100

  # Pod 2: xs7-0100, GPU 2
  xs7-0100-worker-2:
    <<: *xs7-0100-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0100-terachem-2
      - TERACHEM_FE_HOST=xs7-0100-terachem-frontend
  xs7-0100-terachem-2:
    <<: *xs7-0100-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=2

  # Pod 3: xs7-0100, GPU 3
  xs7-0100-worker-3:
    <<: *xs7-0100-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0100-terachem-3
      - TERACHEM_FE_HOST=xs7-0100-terachem-frontend
  xs7-0100-terachem-3:
    <<: *xs7-0100-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=3

  # Pod 4: xs7-0100, GPU 4
  xs7-0100-worker-4:
    <<: *xs7-0100-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0100-terachem-4
      - TERACHEM_FE_HOST=xs7-0100-terachem-frontend
  xs7-0100-terachem-4:
    <<: *xs7-0100-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=4

  # Pod 5: xs7-0100, GPU 5
  xs7-0100-worker-5:
    <<: *xs7-0100-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0100-terachem-5
      - TERACHEM_FE_HOST=xs7-0100-terachem-frontend
  xs7-0100-terachem-5:
    <<: *xs7-0100-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=5

  # Pod 3: xs7-0100, GPU 6
  xs7-0100-worker-6:
    <<: *xs7-0100-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0100-terachem-6
      - TERACHEM_FE_HOST=xs7-0100-terachem-frontend
  xs7-0100-terachem-6:
    <<: *xs7-0100-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=6

  # Pod 3: xs7-0100, GPU 7
  xs7-0100-worker-7:
    <<: *xs7-0100-worker
    environment:
      - TERACHEM_PBS_HOST=xs7-0100-terachem-7
      - TERACHEM_FE_HOST=xs7-0100-terachem-frontend
  xs7-0100-terachem-7:
    <<: *xs7-0100-terachem
    environment:
      - NVIDIA_VISIBLE_DEVICES=7

secrets:
  terachem_license:
    external: true

volumes:
  scratch-vol:
