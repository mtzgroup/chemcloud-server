version: "3.8"

services:
  web-server:
    image: mtzgroup/terachem-cloud
    networks:
      - traefik-public
    environment:
      -
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M
      update_config:
        parallelism: 1
        delay: 10s
      labels:
        - traefik.enable=true
        - traefik.docker.network=traefik-public
        - traefik.constraint-label=traefik-public
        - traefik.http.routers.terachem-cloud-https.rule=Host(`tcc.dev.mtzlab.com`)
        - traefik.http.routers.terachem-cloud-https.entrypoints=https
        - traefik.http.routers.terachem-cloud-https.tls=true
        - traefik.http.routers.terachem-cloud-https.tls.certresolver=le
        - traefik.http.services.terachem-cloud.loadbalancer.server.port=8000

  mq:
    networks:
      - traefik-public
    environment:
      - RABBITMQ_DEFAULT_USER=admin123
      - RABBITMQ_DEFAULT_PASS=supersecret987
    deploy:
      labels:
        - traefik.enable=true
        - traefik.docker.network=traefik-public
        - traefik.constraint-label=traefik-public

        # RabbitMQ
        - traefik.tcp.routers.rmq.rule=HostSNI(`*`)
        - traefik.tcp.routers.rmq.entrypoints=dev-rabbitmq
        - traefik.tcp.routers.rmq.service=rmq-service
        - traefik.tcp.services.rmq-service.loadbalancer.server.port=5672
        - traefik.tcp.routers.rmq.tls=true
        - traefik.tcp.routers.rmq.tls.certresolver=le

        # MGMT Console
        - traefik.http.routers.rabbitmq-console.rule=Host(`rabbitmq.mtzlab.com`)
        - traefik.http.routers.rabbitmq-console.entrypoints=https
        - traefik.http.routers.rabbitmq-console.tls=true
        - traefik.http.routers.rabbitmq-console.tls.certresolver=le
        - traefik.http.routers.rabbitmq-console.service=rabbitmq-console
        - traefik.http.services.rabbitmq-console.loadbalancer.server.port=15672
  redis:
    networks:
      - traefik-public
    volumes:
      - redis:/data
    deploy:
      labels:
        - traefik.enable=true
        - traefik.docker.network=traefik-public
        - traefik.constraint-label=traefik-public

        # RabbitMQ
        - traefik.tcp.routers.redis.rule=HostSNI(`*`)
        - traefik.tcp.routers.redis.entrypoints=redis
        - traefik.tcp.routers.redis.service=redis-service
        - traefik.tcp.services.redis-service.loadbalancer.server.port=6379
        - traefik.tcp.routers.redis.tls=true
        - traefik.tcp.routers.redis.tls.certresolver=le

networks:
  traefik-public:
    external: true
